Task dockerTag = task "dockerTag" {
    group "docker"
}

Delete clean = task "clean"(type: Delete) {
    group "docker"
    delete file("$buildDir/docker")
}

tasks.register ("hello", Exec) {
    executable "echo"
    args = ["1"]
}


["11.0.10-jre-slim-buster", "13.0.2-slim-buster"].each { tag ->

    File dockerBuildDir = file("$buildDir/docker/$tag")
    dockerBuildDir.mkdirs()

    TaskProvider<Task> dockerFileGen = tasks.register("dockerfileJava-$tag"){
        group 'docker'

        String dockerfileContent = file("$projectDir/src/main/docker/template/Dockerfile").text.replace('${IMAGE_TAG}', tag)


        File dockerfile = new File(dockerBuildDir, 'Dockerfile')
        dockerfile.createNewFile()
        dockerfile.text = dockerfileContent
    }

    TaskProvider<Exec> e = tasks.register("dockerTagJava-$tag", Exec) {
        group 'docker'
        dependsOn dockerFileGen

        workingDir dockerBuildDir

        executable "docker"
        args = ["build", "--no-cache","-t", "onstructive/java:$tag", "."]

        logging.captureStandardOutput LogLevel.INFO
        logging.captureStandardError LogLevel.ERROR
    }

    dockerTag.dependsOn << e
}

