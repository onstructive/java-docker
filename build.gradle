Task dockerTag = task "dockerTag" {
    group "docker"
}

Task dockerPush = task "dockerPush" {
    group "docker"
}

tasks.register("clean", Delete) {
    group "docker"
    delete file("$buildDir/docker")
}

tasks.register("hello", Exec) {
    executable "echo"
    args = ["1"]
}

List<String> openJdkTags = [
        "11.0.10-jre-slim-buster",
        "11.0.2-jdk",
        "13.0.2-slim-buster",
        "14.0.2-slim-buster",
        "15.0.2-slim-buster"
]

String timestamp = new Date().format('yyyyMMdd-HHmm')

openJdkTags.each { String tag ->

    File dockerBuildDir = file("$buildDir/docker/$tag")
    dockerBuildDir.mkdirs()

    TaskProvider<Task> dockerFileGen = tasks.register("dockerfileJava-$tag") {
        group 'docker'

        String dockerfileContent = file("$projectDir/src/main/docker/template/Dockerfile").text.replace('${IMAGE_TAG}', tag)

        File dockerfile = new File(dockerBuildDir, 'Dockerfile')
        dockerfile.createNewFile()
        dockerfile.text = dockerfileContent
    }

    TaskProvider<Exec> dockerTagJava = tasks.register("dockerTagJava-$tag", Exec) {
        group 'docker'
        dependsOn dockerFileGen

        workingDir dockerBuildDir

        executable "docker"
        args = ["build", "-t", "onstructive/java:${tag}-${timestamp}", "-t", "onstructive/java:${tag}-latest", "."]

        logging.captureStandardOutput LogLevel.INFO
        logging.captureStandardError LogLevel.ERROR
    }

    TaskProvider<Exec> dockerPushJava = tasks.register("dockerPushJava-$tag", Exec) {
        group 'docker'
        dependsOn dockerTagJava

        workingDir dockerBuildDir

        executable "docker"
        args = ["push", "onstructive/java:${tag}-${timestamp}"]

        logging.captureStandardOutput LogLevel.INFO
        logging.captureStandardError LogLevel.ERROR
    }

    dockerTag.dependsOn << dockerTagJava
    dockerPush.dependsOn << dockerPushJava
}

